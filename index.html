<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤ –ø–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—É</title>
  <script src="https://api.bitrix24.com/api/v1/"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      background: #f5f5f5;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    select {
      width: 100%;
      padding: 5px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <h3>–í—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞ –ø–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—É</h3>
  <label for="templateSelect">–®–∞–±–ª–æ–Ω:</label>
  <select id="templateSelect">
    <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç --</option>
  </select>

<script>
  BX24.init(function() {
    console.log("–í–∏–¥–∂–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω ‚úÖ");

    let templateSelect = document.getElementById("templateSelect");

    // üîπ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤ –ø–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—É
    function loadTemplatesByDepartment(department, currentValue = null) {
      if (!department) {
        templateSelect.innerHTML = "<option value=''>-- –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω --</option>";
        return;
      }

      BX24.callMethod(
        "crm.item.list",
        {
          entityTypeId: 34, // —Å–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å "–®–∞–±–ª–æ–Ω—ã"
          filter: { "ufCrm34UfDepartment": department },
          select: ["id", "ufCrm35UfTemplate"]
        },
        function(result) {
          if (result.error()) {
            console.error("–û—à–∏–±–∫–∞:", result.error());
            return;
          }

          let templates = result.data();
          templateSelect.innerHTML = "";

          if (templates.length === 0) {
            templateSelect.innerHTML = "<option value=''>-- –Ω–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ --</option>";
            return;
          }

          templates.forEach(t => {
            let option = document.createElement("option");
            option.value = t.ufCrm35UfTemplate;
            option.textContent = t.ufCrm35UfTemplate;
            if (currentValue && currentValue === option.value) {
              option.selected = true;
            }
            templateSelect.appendChild(option);
          });

          console.log("–ü–æ–¥–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã:", templates);
        }
      );
    }

    // üîπ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–∞ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª–µ –∑–∞—è–≤–∫–∏
    templateSelect.addEventListener("change", function() {
      let value = this.value;
      if (value) {
        BX24.placement.call("setFieldValue", {
          field: "UF_CRM_33_UF_TEMPLATE",
          value: value
        });
        console.log("–í—ã–±—Ä–∞–Ω —à–∞–±–ª–æ–Ω:", value);
      }
    });

    // üîπ –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    BX24.placement.call("getCardFields", {}, function(result) {
      if (result && result.data) {
        let department = result.data["UF_CRM_33_UF_DEPARTMENT"];
        let currentTemplate = result.data["UF_CRM_33_UF_TEMPLATE"];
        console.log("–ö–∞—Ä—Ç–æ—á–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞. –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:", department, "–¢–µ–∫—É—â–∏–π —à–∞–±–ª–æ–Ω:", currentTemplate);
        loadTemplatesByDepartment(department, currentTemplate);
      }
    });

    // üîπ —Å–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –º–µ–Ω—è–µ—Ç—Å—è)
    BX24.placement.call("addEventListener", {
      event: "onCrmEntityUpdate",
      handler: function(eventData) {
        let department = eventData.currentValues["UF_CRM_33_UF_DEPARTMENT"];
        console.log("–í—ã–±—Ä–∞–Ω –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:", department);
        loadTemplatesByDepartment(department);
      }
    });
  });
</script>
</body>
</html>
