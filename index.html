<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Виджет заявок</title>
  <script src="https://api.bitrix24.com/api/v1/"></script>
</head>
<body>
  <label>Департамент:</label>
  <select id="department"></select>

  <label>Шаблон:</label>
  <select id="template"></select>

  <script>
    // Подключение к Bitrix REST API
    BX24.init(function() {
      // Загружаем список департаментов (из поля UF_CRM_6_1758872949)
      BX24.callMethod(
        "crm.item.list",
        {
          entityTypeId: 6, // ID твоего смарт-процесса "Заявки"
          select: ["id", "ufCrm6Department"]
        },
        function(result) {
          if(result.error()) {
            alert("Ошибка: " + result.error());
          } else {
            let departments = [...new Set(result.data().map(r => r.ufCrm6Department))];
            let depSelect = document.getElementById("department");
            departments.forEach(dep => {
              let option = document.createElement("option");
              option.value = dep;
              option.textContent = dep;
              depSelect.appendChild(option);
            });
          }
        }
      );

      // Слушатель изменения департамента
      document.getElementById("department").addEventListener("change", function() {
        let dep = this.value;

        BX24.callMethod(
          "crm.item.list",
          {
            entityTypeId: 7, // ID смарт-процесса "Шаблоны"
            filter: { "ufCrm7Department": dep },
            select: ["id", "ufCrm7Name"]
          },
          function(result) {
            let templateSelect = document.getElementById("template");
            templateSelect.innerHTML = "";
            result.data().forEach(item => {
              let option = document.createElement("option");
              option.value = item.id;
              option.textContent = item.ufCrm7Name;
              templateSelect.appendChild(option);
            });
          }
        );
      });
    });
  </script>
</body>
</html>
